#!/usr/bin/env bash
set -euo pipefail

# === オプション（環境変数） =========================================
# CHEZMOI_SKIP_ANSIBLE=1    → 常にスキップ
# CHEZMOI_ASSUME_YES=1      → 確認なしで自動Yes（CI用）
# ====================================================================

# スキップ指定
if [ "${CHEZMOI_SKIP_ANSIBLE:-0}" = "1" ]; then
  echo "[run_once] skip ansible install (CHEZMOI_SKIP_ANSIBLE=1)"
  exit 0
fi

# すでに存在なら何もしない
if command -v ansible >/dev/null 2>&1; then
  echo "[run_once] ansible already installed"
  exit 0
fi

confirm_install() {
  # 非対話（標準入力がTTYでない）または自動Yes → そのままYes扱い
  if [ "${CHEZMOI_ASSUME_YES:-0}" = "1" ] || [ ! -t 0 ]; then
    return 0
  fi

  # 対話プロンプト（デフォルト: y）
  local ans
  while true; do
    read -r -p "Install Ansible now? [Y/n]: " ans || ans=""
    case "${ans:-Y}" in
      Y|y) return 0 ;;
      N|n) return 1 ;;
      *)   echo "Please answer Y or n." ;;
    esac
  done
}

if ! confirm_install; then
  echo "[run_once] user chose not to install ansible"
  exit 0
fi

{{ if eq .chezmoi.os "darwin" }}
echo "[run_once] installing Ansible via Homebrew (macOS)"
if ! command -v brew >/dev/null 2>&1; then
  /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
  eval "$(/opt/homebrew/bin/brew shellenv 2>/dev/null || true)"
fi
brew install ansible
{{ else if eq .chezmoi.os "linux" }}
echo "[run_once] installing Ansible via apt (Ubuntu/Debian)"
sudo apt update -y
sudo apt install -y ansible
{{ else }}
echo "[run_once] unsupported OS: {{ .chezmoi.os }} (skip)"
{{ end }}

echo "[run_once] ansible install finished"
